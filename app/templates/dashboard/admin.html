{% extends 'base.html' %}
{% block title %}Admin Panel{% endblock %}

{% block content %}
<style>
.admin-stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px;}
.admin-stat{display:flex;align-items:center;gap:14px;padding:20px;border-radius:var(--radius);background:var(--card-bg);border:1px solid var(--border-color);}
.admin-stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.admin-stat .as-value{font-size:1.6rem;font-weight:700;line-height:1.1;}
.admin-stat .as-label{font-size:0.82rem;color:var(--text-muted);}
</style>

<div class="page-header animate-in">
    <h1 class="text-gradient">Admin Panel</h1>
    <!-- [VULN: CH03-C03] No server-side role check â€” any logged-in user can access -->
    <p>System administration dashboard</p>
</div>

<!-- Admin Stats -->
<div class="admin-stat-grid animate-in" style="animation-delay:0.03s;">
    <div class="admin-stat">
        <div class="admin-stat-icon" style="background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(16,185,129,0.05));">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </div>
        <div>
            <div class="as-value" style="color:var(--accent);">{{ stats.total_users }}</div>
            <div class="as-label">Total Users</div>
        </div>
    </div>
    <div class="admin-stat">
        <div class="admin-stat-icon" style="background:linear-gradient(135deg,rgba(56,189,248,0.15),rgba(56,189,248,0.05));">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--info)" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
        </div>
        <div>
            <div class="as-value" style="color:var(--info);">{{ stats.total_posts }}</div>
            <div class="as-label">Total Posts</div>
        </div>
    </div>
    <div class="admin-stat">
        <div class="admin-stat-icon" style="background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(245,158,11,0.05));">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        </div>
        <div>
            <div class="as-value" style="color:var(--warning);">{{ stats.total_tickets }}</div>
            <div class="as-label">Open Tickets</div>
        </div>
    </div>
</div>

<!-- User Management -->
<div class="card animate-in" style="animation-delay:0.06s;">
    <div class="card-header">
        <h3 style="display:flex;align-items:center;gap:8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            User Management
        </h3>
        <a href="/admin/users" class="btn btn-sm" style="display:flex;align-items:center;gap:4px;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
            Full User List
        </a>
    </div>
    <div class="card-body">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <!-- [VULN: CH04-C07] Password visible in admin panel -->
                    <th style="color:var(--danger);">Password</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr class="animate-in" style="animation-delay:{{ loop.index * 0.02 }}s;">
                    <td style="color:var(--text-muted);">#{{ u.id }}</td>
                    <td><a href="/profile/{{ u.id }}" style="color:var(--accent);">{{ u.username }}</a></td>
                    <td>{{ u.email }}</td>
                    <td><span class="badge {% if u.role == 'superadmin' %}badge-danger{% elif u.role == 'admin' %}badge-warning{% else %}badge-info{% endif %}">{{ u.role }}</span></td>
                    <td class="mono" style="color:var(--danger);font-size:0.85rem;">{{ u.password }}</td>
                    <td>
                        <!-- [VULN: CH03-C05] Role change without authorization -->
                        <form method="POST" action="/admin/users/{{ u.id }}/role" style="display:inline;">
                            <select name="role" onchange="this.form.submit()" style="padding:6px 10px;border-radius:6px;background:var(--surface);border:1px solid var(--border-color);color:var(--text-primary);font-size:0.85rem;">
                                <option value="user" {% if u.role == 'user' %}selected{% endif %}>user</option>
                                <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>admin</option>
                                <option value="superadmin" {% if u.role == 'superadmin' %}selected{% endif %}>superadmin</option>
                            </select>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Admin Config -->
<div class="card mt-2 animate-in" style="animation-delay:0.09s;">
    <div class="card-header">
        <h3 style="display:flex;align-items:center;gap:8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            System Configuration
        </h3>
    </div>
    <div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap;">
        <a href="/api/admin/config" class="btn btn-sm">View Config</a>
        <a href="/api/v1/config" class="btn btn-sm">API v1 Config</a>
        <a href="/debug" class="btn btn-sm">Debug Panel</a>
        <a href="/api/docs" class="btn btn-sm">API Docs</a>
    </div>
</div>

<!-- Access Logs -->
<div class="card mt-2 animate-in" style="animation-delay:0.12s;">
    <div class="card-header">
        <h3 style="display:flex;align-items:center;gap:8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--info)" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
            Recent Access Logs
        </h3>
    </div>
    <div class="card-body">
        {% if logs %}
        <table>
            <thead>
                <tr><th>Time</th><th>User</th><th>Method</th><th>Path</th><th>IP</th><th>User-Agent</th></tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr class="animate-in" style="animation-delay:{{ loop.index * 0.02 }}s;">
                    <td style="color:var(--text-muted);font-size:0.85rem;">{{ log.created_at }}</td>
                    <td>{{ log.user_id or '-' }}</td>
                    <td><span class="badge badge-muted">{{ log.method }}</span></td>
                    <td class="mono" style="font-size:0.85rem;">{{ log.path }}</td>
                    <td style="font-size:0.85rem;">{{ log.ip }}</td>
                    <!-- [VULN: CH11-C07] UA rendered unescaped if stored XSS payload -->
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;font-size:0.82rem;color:var(--text-muted);">{{ log.user_agent | safe }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align:center;padding:24px;">
            <p style="color:var(--text-muted);">No logs available</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
