{% extends 'base.html' %}
{% block title %}Files{% endblock %}

{% block content %}
<div class="page-header animate-in">
    <h1 class="text-gradient">File Manager</h1>
    <p>Upload and download files securely</p>
</div>

<div class="grid grid-2">
    <!-- File List -->
    <div class="card animate-in" style="animation-delay:0.05s;">
        <div class="card-header">
            <h3 style="display:flex; align-items:center; gap:8px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                Your Files
            </h3>
        </div>
        <div class="card-body">
            {% if files %}
            <table>
                <thead>
                    <tr><th>Filename</th><th>Date</th><th>Action</th></tr>
                </thead>
                <tbody>
                    {% for file in files %}
                    <tr>
                        <td class="mono" style="font-size:0.85rem;">{{ file.filename }}</td>
                        <td class="text-muted">{{ file.created_at }}</td>
                        <td>
                            <!-- [VULN: CH05-C01] file parameter vulnerable to path traversal -->
                            <a href="/files/download?file={{ file.filename }}" class="btn btn-sm" style="display:inline-flex; align-items:center; gap:4px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Download
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="text-align:center; padding:32px 20px;">
                <div style="opacity:0.3; margin-bottom:10px;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></div>
                <p style="color:var(--text-muted); font-size:0.9rem;">No files uploaded yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Upload -->
    <div class="card animate-in" style="animation-delay:0.1s;">
        <div class="card-header">
            <h3 style="display:flex; align-items:center; gap:8px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Upload File
            </h3>
        </div>
        <div class="card-body">
            <!-- [VULN: CH13-C10] Client-side only file type validation -->
            <form method="POST" action="/files/upload" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file">Choose file</label>
                    <input type="file" id="file" name="file" onchange="previewFile(this)"
                           accept=".jpg,.jpeg,.png,.gif,.txt,.pdf">
                </div>
                <img id="file-preview" style="display:none; max-width:200px; margin:10px 0; border-radius:var(--radius);">
                <button type="submit" class="btn btn-primary" style="display:flex; align-items:center; gap:6px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Upload
                </button>
            </form>
            
            <hr style="border-color: var(--border-color); margin: 24px 0;">
            
            <h4 style="margin-bottom:12px; display:flex; align-items:center; gap:6px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Direct Download
            </h4>
            <form method="GET" action="/files/download">
                <div class="form-group">
                    <label for="dl-file">Filename</label>
                    <input type="text" id="dl-file" name="file" placeholder="e.g., report.txt or ../../etc/passwd">
                </div>
                <button type="submit" class="btn btn-sm">Download</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
